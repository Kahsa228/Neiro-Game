<!DOCTYPE html>
<html>
<head>
  <title>Cube Arena 3D</title>
  <style>
    body { margin: 0; overflow: hidden; }
    #console {
      position: absolute; right: 0; width: 300px; height: 100%; background: #111;
      color: #0f0; overflow-y: auto; z-index: 2;
    }
    #commandInput { width: 100%; box-sizing: border-box; }
    canvas { display: block; }
  </style>
</head>
<body>
  <div id="console">
    <textarea id="log" readonly rows="25" style="width:100%"></textarea>
    <input type="text" id="commandInput" placeholder="Enter command" />
  </div>

  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
  <script>
    let scene, camera, renderer;
    let players = {}, localPlayerId = null;

    function init3D() {
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0xffffff);

      camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
      camera.position.set(0, 10, 15);
      camera.lookAt(0, 0, 0);

      renderer = new THREE.WebGLRenderer();
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.body.appendChild(renderer.domElement);

      const light = new THREE.HemisphereLight(0xffffff, 0x444444);
      light.position.set(0, 20, 0);
      scene.add(light);

      const floor = new THREE.Mesh(
        new THREE.BoxGeometry(20, 1, 20),
        new THREE.MeshStandardMaterial({ color: 0xdddddd })
      );
      floor.position.y = -0.5;
      scene.add(floor);

      animate();
    }

    function animate() {
      requestAnimationFrame(animate);
      renderer.render(scene, camera);
    }

    function spawnPlayer(id, nickname, pos, color = 0x00ff00) {
      const geometry = new THREE.BoxGeometry(1, 2, 1);
      const material = new THREE.MeshStandardMaterial({ color });
      const mesh = new THREE.Mesh(geometry, material);
      mesh.position.set(pos.x, 1, pos.z);
      scene.add(mesh);
      players[id] = { mesh, nickname, color };
    }

    function updatePlayerPosition(id, pos) {
      if (players[id]) {
        players[id].mesh.position.set(pos.x, 1, pos.z);
      }
    }

    function updatePlayerModel(id, modelName) {
      if (players[id]) {
        players[id].mesh.material.color.setHex(Math.random() * 0xffffff);
      }
    }

    function updatePlayerHealth(id, value) {
      log(`Player ${id} health set to ${value}`);
    }

    const ws = new WebSocket('ws://localhost:8080');
    const nickname = prompt("Enter your nickname:");
    const room = prompt("Enter room name:");

    ws.onopen = () => {
      ws.send(JSON.stringify({ type: 'init', nickname, roomName: room }));
    };

    ws.onmessage = (msg) => {
      const data = JSON.parse(msg.data);
      if (data.type === 'connected') {
        localPlayerId = data.id;
        spawnPlayer(data.id, nickname, data.spawnPoint);
        log("Connected as " + nickname);
      } else if (data.type === 'player_joined') {
        spawnPlayer(data.id, data.nickname, data.position);
        log(data.nickname + " joined the game.");
      } else if (data.type === 'update_health') {
        updatePlayerHealth(data.id, data.value);
      } else if (data.type === 'update_model') {
        updatePlayerModel(data.id, data.model);
      } else if (data.type === 'update_position') {
        updatePlayerPosition(data.id, data.position);
      }
    };

    document.getElementById('commandInput').addEventListener('keydown', function (e) {
      if (e.key === 'Enter') {
        const cmd = e.target.value;
        ws.send(JSON.stringify({ type: 'command', command: cmd }));
        log("> " + cmd);
        e.target.value = '';
      }
    });

    function log(msg) {
      const logBox = document.getElementById('log');
      logBox.value += msg + "\n";
      logBox.scrollTop = logBox.scrollHeight;
    }

    init3D();
  </script>
</body>
    </html>
